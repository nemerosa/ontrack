/**
 * Production tasks
 */

import net.nemerosa.ontrack.gradle.DockerStart
import net.nemerosa.ontrack.gradle.DOSetup

task productionSetup(type: DOSetup) {
    apiToken = project.properties.digitalOceanAccessToken
    dropletName = project.properties.productionMachine
    size = '1gb'
}

task productionEnv {
    mustRunAfter productionSetup
    doFirst {
        project.exec {
            executable 'docker-machine'
            args = ['ssh', project.properties.productionMachine, 'mkdir -p /var/ontrack']
        }
        project.exec {
            executable 'docker-machine'
            args = ['scp', '-r', project.properties.productionConf, "${project.properties.productionMachine}:/var/ontrack/conf"]
        }
    }
}

task productionStart(type: DockerStart) {
    // TODO dependsOn productionStop
    machine = project.properties.productionMachine
    exposePort = false // Exposes 443
    // TODO Container name based on version
    image = "nemerosa/ontrack:${project.properties.ontrackVersion}"
    conf = file('/var/ontrack/conf')
    profile = 'prod'
    mustRunAfter productionEnv
}
