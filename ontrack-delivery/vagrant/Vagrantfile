Vagrant.configure('2') do |config|
  config.vm.box = "hashicorp/precise64"
  # config.vm.forward_port 8080, 3000

  # Configurable VM name
  config.vm.hostname = ENV['VAGRANT_HOST']

  # Digital Ocean provider
  config.vm.provider "digital_ocean" do |provider, override|
    override.ssh.private_key_path = '~/.ssh/id_rsa'
    override.vm.box = 'digital_ocean'
    override.vm.box_url = "https://github.com/smdahlen/vagrant-digitalocean/raw/master/box/digital_ocean.box"
    provider.token = ENV['DO_TOKEN']
    provider.image = ENV['DO_IMAGE']
    provider.region = ENV['DO_REGION']
    provider.size = ENV['DO_SIZE']

    # SSH Key name
    do_key_name = ENV["DO_KEY_NAME"]
    if do_key_name.nil?
      # Default value
      do_key_name = 'Vagrant'
    end
    provider.ssh_key_name = do_key_name
  end

  # Virtual box provider
  config.vm.provider "virtualbox" do |vm|
    vm.name = ENV['VAGRANT_HOST']
  end

  # Docker provisioning

  config.vm.provision "docker" do |docker|

    # Pulling all images
    docker.pull_images ENV['DOCKER_IMAGE_ONTRACK']

    # Running Ontrack
    docker.run "ontrack",
               image: ENV['DOCKER_IMAGE_ONTRACK']
    # TODO Volume /opt/ontrack/mount - to be in a separate volume
  end

  # TODO Installation and configuration of nginx

  # TODO Upgrade of ontrack container?

end